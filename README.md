
# ğŸŒ‘ Cryptarchs of Selene â€“ Phase 1: Lunar Radiometric Preprocessing Pipeline

This project implements **Phase 1** of a modular Lunar Digital Elevation Model (DEM) creation pipeline using calibrated Chandrayaan-2 TMC-2 images.

It performs:
- Radiometric correction using Minnaert's law
- Albedo normalization via Gaussian smoothing
- Shadow detection using sun elevation & reflectance
- Metadata logging and structured output packaging

---

## ğŸ§© Key Features

- ğŸ“‚ Project directory automation and raw geometry file import
- ğŸ§¾ Extraction of metadata from `.xml`, `.spm`, `.oat`
- ğŸŒ€ Conversion from PDS4 `.img` to `.tif` with provenance
- â˜€ï¸ Radiometric correction using the Minnaert model
- ğŸ’¡ Albedo normalization with QC visuals and statistics
- ğŸŒ’ Shadow detection using solar elevation + I/F thresholding
- ğŸ“¦ Phase 1 result packaging for downstream DEM generation

---

## ğŸ“ Directory Structure

```
.
â”œâ”€â”€ main.py                      # Master pipeline controller
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.json              # Global parameter configuration
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ albedo.py                # Albedo normalization
â”‚   â”œâ”€â”€ correction.py            # Minnaert correction
â”‚   â”œâ”€â”€ conversion.py            # PDS4 to TIFF
â”‚   â”œâ”€â”€ cropper.py               # Optional cropping
â”‚   â”œâ”€â”€ data_importer.py         # Raw and geometry file copy
â”‚   â”œâ”€â”€ dir_setup.py             # Folder structure generator
â”‚   â”œâ”€â”€ meta_extc.py             # Metadata extractor
â”‚   â”œâ”€â”€ package_phase1.py        # Output packaging tool
â”‚   â””â”€â”€ shadow.py                # Shadow detection
â”œâ”€â”€ output_package/              # Final Phase-1 deliverables (auto-created)
```

---

# ğŸ“ Project Directory Structure (Phase 1)

This section outlines the directory layout automatically created by the pipeline to manage data flow from raw input to processed outputs.

```
â”œâ”€â”€ <project_name>/ # Generated when the pipeline runs
â”‚
â”‚ â”œâ”€â”€ raw/
â”‚ â”‚ â”œâ”€â”€ img/ # Raw .img files
â”‚ â”‚ â””â”€â”€ xml/ # PDS4 labels
â”‚ â”‚
â”‚ â”œâ”€â”€ browse/ # Optional reference images
â”‚ â”œâ”€â”€ geometry/ # .spm, .oat files (spacecraft/solar angles)
â”‚ â”œâ”€â”€ miscellaneous/ # Extra data (docs, etc.)

â”‚ â”œâ”€â”€ processed/
â”‚ â”‚ â”œâ”€â”€ level0/ # GeoTIFF converted images
â”‚ â”‚ â”œâ”€â”€ level1/ # Minnaert and albedo corrected
â”‚ â”‚ â”‚ â””â”€â”€ shadow_masks/ # Shadow masks and overlays
â”‚ â”‚ â””â”€â”€ level2/ # Placeholder for DEM-ready images
â”‚
â”‚ â”œâ”€â”€ logs/
â”‚ â”‚ â”œâ”€â”€ json/ # Processing provenance
â”‚ â”‚ â”œâ”€â”€ angles/ # Computed solar angles
â”‚ â”‚ â””â”€â”€ *.log # Step-by-step text logs
â”‚
â”‚ â”œâ”€â”€ visuals/ # Histograms, gradient maps, brightness plots
â”‚ â”‚ â”œâ”€â”€ albedo
â”‚ â”‚ â”œâ”€â”€ conversion
â”‚ â”‚ â”œâ”€â”€ crops
â”‚ â”‚ â”œâ”€â”€ correction
â”‚ â”‚ â”œâ”€â”€ shadow_detection   
â”‚ â””â”€â”€ config/ # Step-specific provenance and metadata
```
> ğŸ“ **Note:** All directories are automatically generated by the `main.py` controller using `utils/dir_setup.py`. Each step of the pipeline deposits its outputs in the correct subdirectory to maintain a clean and traceable flow.

## ğŸš€ How to Run the Pipeline

```bash
python main.py \
  --base_dir ./projects \
  --project luna_phase1 \
  --root_dir data_input_dir_name \
  --process_mode both \
  --original_tif_name your_file.img \
  --crop_coords 100,100,1000,1000 \
  --crop_name cropped_image.tif
```

### Arguments

| Argument              | Description                                                       |
|-----------------------|-------------------------------------------------------------------|
| `--base_dir`          | Path to the main directory where your project folder will reside  |
| `--project`           | Name for the current project directory                            |
| `--root_dir`          | Folder with raw `.img`, `.xml`, `.spm`, `.oat` files              |
| `--process_mode`      | Choose between `original`, `crop`, or `both`                      |
| `--original_tif_name` | TIFF file name after conversion (used for cropping)               |
| `--crop_coords`       | Cropping rectangle: `xmin,ymin,xmax,ymax`                         |
| `--crop_name`         | Output name for the cropped image (default: `cropped_image.tif`)  |

---

## âš™ï¸ Configuration

Global settings for correction algorithms are stored in:

```
config/config.json
```

### Example

```json
{
  "minnaert": {
    "k_exponent": 0.5,
    "gain": 0.0015,
    "dark_current": 82.0
  },
  "albedo": {
    "sigma": 15
  },
  "shadow": {
    "sun_el_threshold": 5.0,
    "abs_if_threshold": 0.01,
    "threshold_factor": 0.2,
    "min_if_valid": 0.001,
    "morph_iters": 2
  }
}
```

---

## ğŸ“¦ Phase 1 Output Packaging

Packaged in `output_package/`, ready for Phase 2 (DEM generation):

| File Name                   | Description                                           |
|----------------------------|-------------------------------------------------------|
| `*_corrected_image.tif`     | Radiometrically corrected image (Minnaert)           |
| `*_albnorm.tif`             | Albedo-normalized version of I/F image               |
| `*_shadowmask.tif`          | Binary shadow mask                                   |
| `conversion_provenance.jsonl` | Line-based JSON log of file conversion steps       |
| `sun_angles.json`           | Per-tile sun azimuth/elevation values                |
| `albedo_qc.csv`             | QC statistics after albedo normalization             |
| `shadow_coverage.csv`       | Per-tile shadow coverage stats                       |
| `shadow_coverage_bar.png`   | Bar plot of % shadow coverage                        |

> All logs and visuals are also preserved under `logs/` and `visuals/`.

---

## ğŸ§ª Conda Environment Setup

### 1. Create Environment

```bash
conda create -n luna_env python=3.10 -y
conda activate luna_env
```

### 2. Install Dependencies

```bash
conda install -y gdal:forge
```

```bash
pip install -r requirements.txt
```

```bash
conda env create -f environment.yml
conda activate luna_env
```
---

## ğŸ“„ `requirements.txt`

```txt
numpy
rasterio
matplotlib
scipy
pandas
```

> Add any additional packages you use in later phases.

---

## ğŸ›  Advanced Features

- âœ… Modular utility design â€” every step is in `utils/`
- âœ… Logging with timestamps at every major processing step
- âœ… Visual diagnostics (histograms, overlays, brightness profiles)
- âœ… Flexible configuration through `config/config.json`
- âœ… Output packaging for reproducibility and auditability

---

## ğŸ§­ Roadmap

| Phase | Description                              |
|-------|------------------------------------------|
| 1     | Radiometric correction & shadow masking  |
| 2     | DEM creation via Shape from Shading      |
| 3     | 3D mesh export & visualization           |
| 4     | Feature detection, mapping, crater stats |

---

## ğŸ™Œ Contribution

If you'd like to contribute:
- Stick to modular functions in `utils/`
- Document any new configuration options in `config.json`
- Maintain consistent logging & structure

---

## ğŸ“¬ Contact

Developed by: **Cryptarchs of Selene**  
For Isro Hackathon and research use only.

---

> ğŸš€ "Unveiling the Moon, one pixel at a time."
